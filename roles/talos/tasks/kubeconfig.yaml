---

- name: Get kubeconfig
  run_once: true
  retries: 10
  delay: 30
  register: result
  until: result.rc == 0
  shell: >
    talosctl kubeconfig
    --talosconfig secrets/talosconfig.yaml
    -f
    -m=false
    -n {{ cluster_vip }}
    -e {{ cluster_vip }}
    {{ kubeconfig_path }}
  args:
    chdir: "{{ inventory_dir }}/clusters/{{ cluster_name }}"
